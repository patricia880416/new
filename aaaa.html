<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æº«é¦¨ç†è²¡æ‰‹å¸³ V14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --oatmeal: #f5f2ed; --warm-gray: #5d544e; --earth-green: #5a705c; --wood-brown: #8a6d4d; --latte: #e8e2d6; }
        body { background-color: var(--oatmeal); font-family: sans-serif; color: var(--warm-gray); margin: 0; -webkit-tap-highlight-color: transparent; }
        .warm-card { background: white; border-radius: 24px; border: 1px solid var(--latte); margin-bottom: 1rem; }
        .btn-green { background-color: var(--earth-green) !important; color: white !important; border-radius: 18px; font-weight: bold; }
        .btn-main { background-color: var(--wood-brown) !important; color: white !important; padding: 14px; border-radius: 16px; font-weight: bold; width: 100%; }
        .btn-action-big { padding: 20px !important; font-size: 18px !important; width: 100%; display: block; border-radius: 20px; }
        .input-box { background: #faf9f7; border: 1.5px solid var(--latte); border-radius: 14px; padding: 12px; width: 100%; outline: none; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-blur: 3px; }
        .modal-content { background: white; width: 92%; max-width: 400px; border-radius: 28px; padding: 24px; max-height: 85vh; overflow-y: auto; }
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; }
        .save-cell { aspect-ratio: 1; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 1px solid var(--latte); background: white; cursor: pointer; }
        .cell-done { background: var(--earth-green) !important; color: white !important; border-color: var(--earth-green) !important; }
        .tab-active { color: var(--wood-brown); font-weight: bold; position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: -8px; left: 20%; width: 60%; height: 3px; background: var(--wood-brown); border-radius: 10px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 242, 237, 0.9); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="pb-20">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#8a6d4d]"></div>
        <p class="mt-4 text-xs font-bold text-[#8a6d4d]">åŒæ­¥ä¸­...</p>
    </div>

    <div class="pt-10 pb-4 text-center">
        <h1 class="text-2xl font-serif font-bold tracking-widest">ç”Ÿæ´»æ‰‹å¸³</h1>
        <p id="randomSlogan" class="text-[11px] text-[#8a6d4d] mt-1 italic"></p>
    </div>

    <nav class="sticky top-0 z-50 bg-[#f5f2ed]/90 backdrop-blur-md border-b border-[#e8e2d6] mb-6">
        <div class="max-w-md mx-auto flex justify-around py-4">
            <button onclick="switchPage('ledger')" id="nav-ledger" class="text-sm tab-active">æ—¥å¸¸è¨˜å¸³</button>
            <button onclick="switchPage('savings')" id="nav-savings" class="text-sm text-gray-400">å„²è“„æŒ‘æˆ°</button>
        </div>
    </nav>

    <div class="max-w-md mx-auto px-5">
        
        <div id="page-ledger">
            <div class="warm-card p-8 text-center">
                <p class="text-[10px] tracking-widest text-gray-400 uppercase mb-1">Current Balance</p>
                <h2 class="text-4xl font-serif font-bold text-[#5d544e]" id="balanceDisplay">$ 0</h2>
                <button onclick="fetchCloudData()" class="mt-4 text-[10px] text-[#8a6d4d] font-bold underline">åˆ·æ–°é›²ç«¯æ•¸æ“š</button>
            </div>

            <div class="warm-card p-6">
                <div class="flex justify-center gap-10 mb-6 text-sm">
                    <button id="tabExp" onclick="changeType('expense')" class="font-bold text-[#8a6d4d] border-b-2 border-[#8a6d4d] pb-1">æ”¯å‡º</button>
                    <button id="tabInc" onclick="changeType('income')" class="text-gray-400 pb-1">æ”¶å…¥</button>
                </div>
                <div class="space-y-4">
                    <input type="date" id="dateInput" class="input-box">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="catInput" class="input-box"></select>
                        <select id="methodInput" class="input-box"></select>
                    </div>
                    <input type="number" id="amtInput" placeholder="è¼¸å…¥é‡‘é¡" class="input-box text-lg font-bold" inputmode="decimal">
                    <input type="text" id="noteInput" placeholder="å¯«é»ä»€éº¼ç´€éŒ„ç”Ÿæ´»..." class="input-box">
                    <button onclick="saveToCloud()" class="btn-main shadow-lg">è¨˜éŒ„é€™ä¸€ç­†</button>
                </div>
            </div>
            <div id="list" class="space-y-4 pb-10"></div>
        </div>

        <div id="page-savings" class="hidden">
            <div class="warm-card p-6 flex justify-between items-center bg-white shadow-sm">
                <div>
                    <p class="text-[10px] text-gray-400 font-bold tracking-widest">ç›®å‰ç¸½å­˜æ¬¾</p>
                    <h2 class="text-3xl font-serif font-bold text-[#5a705c]" id="totalSavingsDisplay">$ 0</h2>
                </div>
                <i class="fas fa-piggy-bank text-2xl text-[#5a705c]"></i>
            </div>
            <button onclick="openCreateModal()" class="btn-green btn-action-big shadow-lg mb-8 font-bold">+ å»ºç«‹æ–°çš„å„²è“„è¨ˆç•«</button>
            <div id="goalList" class="space-y-6"></div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="font-bold text-center mb-6 text-lg">âœ¨ æ–°è¨ˆç•«è¨­å®š</h3>
            <div class="space-y-5">
                <input type="text" id="newName" placeholder="è¨ˆç•«åç¨±" class="input-box">
                <input type="number" id="newTarget" placeholder="å–®æ¬¡é‡‘é¡ (å›ºå®š/52é€±)" class="input-box" inputmode="numeric">
                <select id="newMode" class="input-box">
                    <option value="365">ğŸ“… 365å¤©æŒ‘æˆ° (1~365æ ¼)</option>
                    <option value="52">ğŸ“… 52é€±æŒ‘æˆ° (52æ ¼)</option>
                    <option value="random">ğŸ² éš¨æ©Ÿå­˜éŒ¢ (50~200å…ƒ)</option>
                    <option value="fixed">ğŸ’° å›ºå®šå­˜éŒ¢ (ç¢ºèªå³å­˜)</option>
                </select>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeModals()" class="flex-1 py-4 text-sm font-bold text-gray-400">å–æ¶ˆ</button>
                    <button onclick="confirmCreate()" class="flex-1 btn-green py-4 text-sm shadow-md">ç¢ºèªå»ºç«‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="saveActionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalGoalName" class="font-bold text-lg text-[#5d544e]"></h3>
                <button onclick="closeModals()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="modalActionArea"></div>
            <hr class="my-6 border-latte">
            <button onclick="undoLastSave()" class="w-full py-3 mb-2 text-sm text-[#8a6d4d] border border-[#e8e2d6] rounded-xl font-bold">åæ‚”ï¼å–æ¶ˆä¸Šä¸€ç­†æ ¼</button>
            <button onclick="deleteCurrentGoal()" class="w-full py-4 text-sm text-red-400 font-bold bg-red-50 rounded-xl mt-4">å¾¹åº•åˆªé™¤è¨ˆç•«</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzLFvZ4VAIVfjukkevj9DSqx-7p3hd0YQZxf16noKfIZXg9Ti3Vkf3YrbQmMlRStVxvKg/exec";
        const slogans = ["æ¯ä¸€ç­†è¨˜éŒ„ï¼Œéƒ½æ˜¯ç”Ÿæ´»çš„æ¨£å­ âœ¨", "å­˜éŒ¢ï¼Œæ˜¯ç‚ºäº†é‡è¦‹æ›´å¥½çš„è‡ªå·± ğŸ•Šï¸", "ä»Šå¤©ä¹Ÿè¦å°è‡ªå·±æº«æŸ”ä¸€é» â˜•"];
        
        let records = [];
        let goals = JSON.parse(localStorage.getItem('v14_savings_data')) || [];
        let currentType = 'expense';
        let activeGoalId = null;

        const cats = { expense: ['ğŸ½ï¸ é£²é£Ÿ', 'ğŸš— äº¤é€š', 'ğŸ® å¨›æ¨‚', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ”§ å…¶ä»–'], income: ['ğŸ’° è–ªè³‡', 'ğŸ“ˆ æŠ•è³‡', 'âœ¨ å…¶ä»–'] };
        const methods = { expense: ['ğŸ’µ ç¾é‡‘', 'ğŸ’³ ä¿¡ç”¨å¡', 'ğŸŸ¢ LINE Pay'], income: ['ğŸ¦ éŠ€è¡Œè½‰å¸³', 'ğŸ’µ ç¾é‡‘'] };

        window.onload = () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            refreshForm(); updateSlogan(); renderGoals(); fetchCloudData();
        };

        // --- å„²è“„æ ¸å¿ƒé‚è¼¯ ---
        function openCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        
        function confirmCreate() {
            const name = document.getElementById('newName').value;
            const target = parseFloat(document.getElementById('newTarget').value) || 0;
            const mode = document.getElementById('newMode').value;
            if (!name) return alert("è«‹è¼¸å…¥åç¨±");
            let total = target;
            if (mode === '365') total = 66795;
            if (mode === '52') total = target * 52;
            goals.push({ id: Date.now(), name, target: total, unitAmt: target, mode, current: 0, history: [] });
            saveAndRender(); closeModals();
        }

        function openSaveAction(id) {
            activeGoalId = id;
            const g = goals.find(x => x.id === id);
            document.getElementById('modalGoalName').innerText = g.name;
            const area = document.getElementById('modalActionArea');
            area.innerHTML = '';

            if (g.mode === '365' || g.mode === '52') {
                const count = (g.mode === '365') ? 365 : 52;
                area.innerHTML = `<div class="grid-container" id="cellGrid"></div>`;
                const grid = area.querySelector('#cellGrid');
                for (let i = 1; i <= count; i++) {
                    const amt = (g.mode === '365') ? i : g.unitAmt;
                    const isDone = (g.mode === '365') ? g.history.includes(i) : g.history.length >= i;
                    grid.innerHTML += `<div onclick="${isDone?'':'doSave('+amt+','+i+')'}" class="save-cell ${isDone?'cell-done':''}">$${amt}</div>`;
                }
            } else if (g.mode === 'random') {
                const rand = Math.floor(Math.random() * (200 - 50 + 1)) + 50;
                area.innerHTML = `<div class="text-center py-6"><h1 class="text-5xl font-bold text-[#8a6d4d] mb-6">$ ${rand}</h1><button onclick="doSave(${rand}, ${rand})" class="btn-green btn-action-big shadow-xl font-bold">ç¢ºèªå­˜å…¥</button></div>`;
            } else {
                area.innerHTML = `<div class="text-center py-6"><h1 class="text-5xl font-bold text-[#5a705c] mb-6">$ ${g.unitAmt}</h1><button onclick="doSave(${g.unitAmt}, ${g.unitAmt})" class="btn-green btn-action-big shadow-xl font-bold">ç¢ºèªå­˜å…¥</button></div>`;
            }
            document.getElementById('saveActionModal').style.display = 'flex';
        }

        function doSave(amt, marker) {
            const g = goals.find(x => x.id === activeGoalId);
            g.current += amt; g.history.push(marker);
            saveAndRender(); openSaveAction(activeGoalId);
        }

        function undoLastSave() {
            const g = goals.find(x => x.id === activeGoalId);
            if (g.history.length === 0) return;
            const lastMarker = g.history.pop();
            // å¦‚æœæ˜¯ 365 æ¨¡å¼ï¼Œmarker æœ¬èº«å°±æ˜¯é‡‘é¡ï¼›å¦‚æœæ˜¯ 52 æˆ–å›ºå®šæ¨¡å¼ï¼Œé‡‘é¡æ˜¯ unitAmt
            const amtToSubtract = (g.mode === '365') ? lastMarker : (g.mode === '52' ? g.unitAmt : lastMarker);
            g.current -= amtToSubtract;
            saveAndRender(); openSaveAction(activeGoalId);
        }

        // --- è¨˜å¸³æ ¸å¿ƒé‚è¼¯ ---
        async function fetchCloudData() {
            toggleLoader(true);
            try {
                const res = await fetch(API_URL);
                records = (await res.json()).reverse();
                renderLedger();
            } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        async function saveToCloud() {
            const amtElem = document.getElementById('amtInput');
            if (!amtElem.value) return alert("è«‹è¼¸å…¥é‡‘é¡");
            const data = { date: document.getElementById('dateInput').value, type: currentType, cat: document.getElementById('catInput').value, method: document.getElementById('methodInput').value, attr: 'è®Šå‹•æ”¯å‡º', amt: parseFloat(amtElem.value), note: document.getElementById('noteInput').value };
            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                amtElem.value = ''; document.getElementById('noteInput').value = '';
                setTimeout(fetchCloudData, 1500);
            } catch (e) { toggleLoader(false); }
        }

        function renderLedger() {
            const list = document.getElementById('list');
            let bal = 0;
            records.forEach(r => bal += (r.type === 'income' ? Number(r.amt) : -Number(r.amt)));
            document.getElementById('balanceDisplay').innerText = '$ ' + bal.toLocaleString();
            list.innerHTML = records.slice(0, 10).map(r => `
                <div class="warm-card p-4 flex justify-between items-center border-none shadow-sm bg-[#faf9f7]">
                    <div><span class="font-bold text-xs">${r.cat}</span><p class="text-[10px] text-gray-400">${r.date} ${r.note?'Â· '+r.note:''}</p></div>
                    <p class="font-bold text-sm ${r.type==='income'?'text-[#5a705c]':'text-[#8a6d4d]'}">${r.type==='income'?'+':'-'}${Number(r.amt).toLocaleString()}</p>
                </div>`).join('');
        }

        // --- åŸºç¤é€šç”¨ ---
        function saveAndRender() { localStorage.setItem('v14_savings_data', JSON.stringify(goals)); renderGoals(); }
        function renderGoals() {
            const container = document.getElementById('goalList');
            let total = 0;
            container.innerHTML = goals.map(g => {
                total += g.current;
                const progress = Math.min(100, Math.floor((g.current / g.target) * 100));
                return `<div class="warm-card p-6 shadow-sm"><div class="flex justify-between mb-3"><h4 class="font-bold text-base">${g.name}</h4><span class="text-xs font-bold text-[#5a705c]">${progress}%</span></div><div class="w-full bg-gray-100 rounded-full h-3 mb-4 overflow-hidden shadow-inner"><div class="bg-[#5a705c] h-full" style="width:${progress}%"></div></div><div class="flex justify-between items-center"><span class="text-[11px] font-bold text-[#8a6d4d]">å·²å­˜: $${g.current.toLocaleString()}</span><button onclick="openSaveAction(${g.id})" class="btn-green px-10 py-4 text-base font-bold shadow-md">é»æˆ‘å­˜éŒ¢</button></div></div>`;
            }).join('');
            document.getElementById('totalSavingsDisplay').innerText = '$ ' + total.toLocaleString();
        }
        function deleteCurrentGoal() { if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { goals = goals.filter(g => g.id !== activeGoalId); saveAndRender(); closeModals(); } }
        function switchPage(p) {
            document.getElementById('page-ledger').classList.toggle('hidden', p !== 'ledger');
            document.getElementById('page-savings').classList.toggle('hidden', p !== 'savings');
            document.getElementById('nav-ledger').className = p === 'ledger' ? 'text-sm tab-active' : 'text-sm text-gray-400';
            document.getElementById('nav-savings').className = p === 'savings' ? 'text-sm tab-active' : 'text-sm text-gray-400';
        }
        function changeType(t) { currentType = t; refreshForm(); }
        function refreshForm() {
            document.getElementById('catInput').innerHTML = cats[currentType].map(c => `<option>${c}</option>`).join('');
            document.getElementById('methodInput').innerHTML = methods[currentType].map(m => `<option>${m}</option>`).join('');
            document.getElementById('tabExp').className = currentType==='expense'?'font-bold text-[#8a6d4d] border-b-2 border-[#8a6d4d] pb-1':'text-gray-400 pb-1';
            document.getElementById('tabInc').className = currentType==='income'?'font-bold text-[#5a705c] border-b-2 border-[#5a705c] pb-1':'text-gray-400 pb-1';
        }
        function updateSlogan() { document.getElementById('randomSlogan').innerText = slogans[Math.floor(Math.random() * slogans.length)]; }
        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    </script>
</body>

</html>
